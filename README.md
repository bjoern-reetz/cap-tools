
Python data bindings for the [Common Alerting Protocol Version 1.2](https://docs.oasis-open.org/emergency/cap/v1.2/CAP-v1.2.html).

## Getting started

This package contains a Python model for CAP XML documents that was generated using using [xsData](https://xsdata.readthedocs.io/) along with some convenience utilities.

To parse a CAP XML from a file into an instance of `cappy.models.Alert`, do as follows:

```python
from cappy.models import Alert
from xsdata.formats.dataclass.parsers import XmlParser

parser = XmlParser()
alert = parser.parse("path/to/my/cap.xml", Alert)
```

For advanced usage, just take a look at the [xsData](https://xsdata.readthedocs.io/en/latest/data_binding/basics/) docs.

### Convenience utilities

In addition to the code that was generated using xsData, this library adds some convenience utilities on top.

#### Mapping system-specific key-value-pairs to `dict`s

The `Info.parameters`, `Info.event_codes` and `Area.geocode` fields generated by xsData are implemented as a list of (containers of) key-value-pairs.

```python
>>> alert = parser.parse(cap_xml_path, cap_tools.models.Alert)
>>> alert.infos[0].parameters
[Parameter(value_name=ValueName(value='EventID'), value=Value(value='13970876')), Parameter(value_name=ValueName(value='Version'), value=Value(value='1')), Parameter(value_name=ValueName(value='Magnitude'), value=Value(value='3.4 Ml')), Parameter(value_name=ValueName(value='Depth'), value=Value(value='11.8 mi.')), Parameter(value_name=ValueName(value='Quality'), value=Value(value='Excellent'))]
```

This can more ergonomically be represented using Python dictionaries. Use the `Info.parameters_to_dict`, `Info.event_codes_to_dict` and `Area.geocode_to_dict` methods to create dictionaries from the data.

```python
>>> alert.infos[0].parameters_to_dict()
{'EventID': '13970876', 'Version': '1', 'Magnitude': '3.4 Ml', 'Depth': '11.8 mi.', 'Quality': 'Excellent'}
```

You can also write dictionary data to the instance fields using the `Info.parameters_from_dict`, `Info.event_codes_from_dict` and `Area.geocode_from_dict` methods.

```python
>>> alert.infos[0].parameters_from_dict({"foo": "bar", "lorem": "ipsum"})
>>> alert.infos[0].parameters
[Parameter(value_name=ValueName(value='foo'), value=Value(value='bar')), Parameter(value_name=ValueName(value='lorem'), value=Value(value='ipsum'))]
```

The dictionaries do not retain any connection to the model. In all cases, the internal state is always represented by the list of containers of key-value-pairs.

#### Awareness of "en-US" as the default language

When no language is explicitly defined on an Info element, "en-US" is assumed per CAP spec. This library implements this behavior neither by using default values nor by using descriptor fields.

```python
>>> alert.infos[0].language = "en-US"
>>> alert.infos[0].language
'en-US'
>>> alert.infos[0].language = None
>>> alert.infos[0].language is None
True
>>> alert.infos[0].language == "en-US"
False
```

To still have this "absence means en-US" logic implemented, two convenience methods are added to Info.

```python
>>> alert.infos[0].set_language("de-DE")
>>> alert.infos[0].language
'de-DE'
>>> alert.infos[0].set_language("en-US")
>>> alert.infos[0].language is None
True
>>> alert.infos[0].get_language()
'en-US'
```

Using `Info.get_language()` returns `"en-US"` when `Info.language` is `None` and `Info.set_language("en-US")` sets `Info.language` to `None` (implicitly "en-US") instead of `"en-US"` (explicitly).

## Limitations

While this library is fully typed to enable Python type safety, it currently does neither implement the pattern restrictions from the [CAP v1.2 XSD specification](./CAP-v1.2.xsd) (i.e. the pattern restriction for the XmlDateTime fields) nor the additional restrictions imposed by the [normative alert message structure](https://docs.oasis-open.org/emergency/cap/v1.2/CAP-v1.2.html#_Toc454352650) (e.g. Alert.identifier must not include spaces, commas or the characters "<" and "&").

This does not matter much when using this library for reading CAP messages - but when you are using this library to create CAP messages, **you are responsible** for respecting those additional restrictions yourself!
